<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal Cliente - Alta</title>
  <script src="env.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 720px; margin: 20px auto; }
    label { display:block; margin-top: 8px; }
    input, select { width: 100%; padding: 8px; }
    button { margin-top: 12px; padding: 10px 14px; }
    .ok { color: green; }
    .err { color: red; }
    .muted { color:#666; font-size: 0.9em; }
  </style>
  <script>
    // Utilidades
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    async function fetchJSON(url, { timeout = 3000 } = {}) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort('timeout'), timeout);
      try {
        const r = await fetch(url, { signal: ctrl.signal });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.json();
      } finally { clearTimeout(t); }
    }

    async function resolveCatalogBase() {
      // 1) Candidatos de URL (prioriza variables inyectadas, luego puertos comunes)
      const hostnames = [window.location.hostname, 'localhost', '127.0.0.1'];
      const catPorts = [
        window.CAT_PORT,
        window.HOST_CATALOGO_PORT,
        window.ENV && window.ENV.HOST_CATALOGO_PORT,
        8005, 8001
      ].filter(Boolean);

      const manualFirst = [];
      if (window.CAT_URL) manualFirst.push(window.CAT_URL);

      const bases = [
        ...manualFirst,
        ...hostnames.flatMap(h => catPorts.map(p => `http://${h}:${p}`))
      ].filter((v, i, a) => v && a.indexOf(v) === i); // únicos

      // 2) Probar secuencialmente hasta encontrar /zonas funcional y con datos
      for (const base of bases) {
        try {
          const zonas = await fetchJSON(`${base}/zonas`, { timeout: 3000 });
          if (Array.isArray(zonas) && zonas.length > 0) {
            return { base, zonas };
          }
        } catch (_) { /* intenta el siguiente */ }
      }
      return { base: null, zonas: [] };
    }

    async function resolveOrqBase() {
      const hostnames = [window.location.hostname, 'localhost', '127.0.0.1'];
      const orqPorts = [
        window.ORQ_PORT,
        window.HOST_ORQ_PORT,
        window.ENV && window.ENV.HOST_ORQ_PORT,
        8010, 8011
      ].filter(Boolean);

      const manualFirst = [];
      if (window.ORQ_URL) manualFirst.push(window.ORQ_URL);

      const bases = [
        ...manualFirst,
        ...hostnames.flatMap(h => orqPorts.map(p => `http://${h}:${p}`))
      ].filter((v, i, a) => v && a.indexOf(v) === i);

      // Si alguno responde /health 200, lo tomamos; si no, usamos el primero como best-effort
      for (const base of bases) {
        try {
          const r = await fetch(`${base}/health`, { method: 'GET' });
          if (r.ok) return base;
        } catch (_) { /* sigue */ }
      }
      return bases[0] || null;
    }

    function validarRFC(val){ return /^[A-Z&Ñ]{3,4}\d{6}[A-Z0-9]{3}$/i.test(val.trim()); }
    function validarTel(val){ return /^\+?\d{10,15}$/.test(val.replace(/[-\s]/g,'')); }
    function setError(id, ok){ const el=document.getElementById(id); el.style.borderColor = ok?'#0a0':'#c00'; }

    async function load() {
      // Placeholder para que Playwright detecte options aunque tarde el fetch
      const zonaSel = document.getElementById('zona');
      const planSel = document.getElementById('plan');
      zonaSel.innerHTML = '<option disabled selected value="">Cargando zonas…</option>';
      planSel.innerHTML = '<option disabled selected value="">Cargando planes…</option>';

      // Resolver catálogo (8005/8001, distintos hosts) y precargar zonas
      const { base: CAT_BASE, zonas } = await resolveCatalogBase();

      if (!CAT_BASE) {
        // Fallback de supervivencia: asegura que exista al menos NORTE/SUR para no romper E2E
        zonaSel.innerHTML = '';
        ['NORTE','SUR'].forEach(z => {
          const o = document.createElement('option');
          o.value = z; o.textContent = z;
          zonaSel.appendChild(o);
        });
        document.getElementById('result').textContent =
          'No se pudo contactar al catálogo. Usando zonas de fallback.';
        document.getElementById('result').className = 'muted';
      } else {
        // Poblar zonas desde servicio real
        zonaSel.innerHTML = '';
        zonas.forEach(z => {
          const o = document.createElement('option');
          o.value = z.id;
          o.textContent = z.id;
          zonaSel.appendChild(o);
        });
      }

      // Planes
      let planes = [];
      if (CAT_BASE) {
        try {
          planes = await fetchJSON(`${CAT_BASE}/planes`, { timeout: 4000 });
        } catch (_) { planes = []; }
      }
      planSel.innerHTML = '';
      if (Array.isArray(planes) && planes.length) {
        planes.forEach(p => {
          const o = document.createElement('option');
          o.value = p.codigo || p.id || p.nombre || 'PLAN';
          const precio = (p.precio != null) ? ` - $${p.precio}` : '';
          o.textContent = `${p.codigo || p.nombre || 'PLAN'}${precio}`;
          planSel.appendChild(o);
        });
      } else {
        // Fallback mínimo si /planes no responde
        [
          { codigo:'BASICO-50', precio:399 },
          { codigo:'AVANZADO-100', precio:549 }
        ].forEach(p => {
          const o = document.createElement('option');
          o.value = p.codigo;
          o.textContent = `${p.codigo} - $${p.precio}`;
          planSel.appendChild(o);
        });
      }

      // Resolver ORQ url (intenta /health)
      const ORQ_BASE = await resolveOrqBase();

      // Guardar URLs globalmente (útil en E2E y otras páginas)
      window.CAT_URL = CAT_BASE || null;
      window.ORQ_URL = ORQ_BASE || null;

      // Si no hay ORQ, avisa (pero deja el formulario usable para pruebas de UI)
      if (!window.ORQ_URL) {
        const res=document.getElementById('result');
        res.textContent = 'No se encontró el orquestador (ORQ). Verifica que esté arriba (p.ej. :8010).';
        res.className = 'muted';
      }
    }

    async function alta(e){
      e.preventDefault();
      const rfcOk = validarRFC(document.getElementById('rfc').value); setError('rfc', rfcOk);
      const telOk = validarTel(document.getElementById('telefono').value); setError('telefono', telOk);
      const res=document.getElementById('result');

      if(!rfcOk || !telOk){
        res.textContent = 'Corrige validaciones de RFC/Teléfono';
        res.className='err';
        return;
      }

      if (!window.ORQ_URL){
        res.textContent = 'No hay ORQ_URL disponible. Asegúrate de que el orquestador esté corriendo (p.ej. puerto 8010).';
        res.className = 'err';
        return;
      }

      const body = {
        nombre: document.getElementById('nombre').value,
        rfc: document.getElementById('rfc').value,
        email: document.getElementById('email').value,
        telefono: document.getElementById('telefono').value,
        plan_id: document.getElementById('plan').value,
        domicilio: {
          calle: document.getElementById('calle').value,
          numero: document.getElementById('numero').value,
          colonia: document.getElementById('colonia').value,
          cp: document.getElementById('cp').value,
          ciudad: document.getElementById('ciudad').value,
          estado: document.getElementById('estado').value,
          zona: document.getElementById('zona').value,
        },
        contacto: {
          nombre: document.getElementById('nombre').value,
          email: document.getElementById('email').value,
          telefono: document.getElementById('telefono').value,
        },
        consentimiento: { marketing: true, terminos: true },
        idem: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now())
      };

      try {
        const r = await fetch(`${window.ORQ_URL}/saga/alta-cliente`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        }).then(r=>r.json());
        res.textContent = JSON.stringify(r, null, 2);
        res.className = r && r.error ? 'err' : 'ok';
      } catch (err) {
        res.textContent = `Error llamando a ORQ: ${err.message}`;
        res.className = 'err';
      }
    }

    window.addEventListener('DOMContentLoaded', load);
    document.addEventListener('input', (e)=>{
      if(e.target && e.target.id==='rfc') setError('rfc', validarRFC(e.target.value));
      if(e.target && e.target.id==='telefono') setError('telefono', validarTel(e.target.value));
    });
  </script>
</head>
<body>
  <h1>Alta de cliente</h1>
  <form onsubmit="alta(event)">
    <label>Nombre <input id="nombre" required /></label>
    <label>RFC <input id="rfc" required placeholder="AAA010101AAA"/></label>
    <label>Email <input id="email" type="email" required /></label>
    <label>Teléfono <input id="telefono" required placeholder="5555555555"/></label>
    <fieldset>
      <legend>Domicilio</legend>
      <label>Calle <input id="calle" /></label>
      <label>Número <input id="numero" /></label>
      <label>Colonia <input id="colonia" /></label>
      <label>CP <input id="cp" /></label>
      <label>Ciudad <input id="ciudad" /></label>
      <label>Estado <input id="estado" /></label>
      <label>Zona <select id="zona"></select></label>
    </fieldset>
    <label>Plan <select id="plan"></select></label>
    <button type="submit">Crear</button>
  </form>
  <pre id="result" class="muted">Listo para iniciar.</pre>
</body>
</html>
